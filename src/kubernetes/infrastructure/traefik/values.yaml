# Traefik Helm Chart Values
# Ingress controller for *.zinkzone.tech

# Global options
globalArguments:
  - "--global.checknewversion=false"
  - "--global.sendanonymoususage=false"

# Additional arguments for Traefik
additionalArguments:
  # Enable dashboard (secured by middleware later)
  - "--api.dashboard=true"
  - "--api.insecure=false"

  # Logging
  - "--log.level=INFO"
  - "--accesslog=true"

  # Let's Encrypt / ACME
  - "--certificatesresolvers.cloudflare.acme.email=williamdzink@gmail.com"
  - "--certificatesresolvers.cloudflare.acme.storage=/data/acme.json"
  - "--certificatesresolvers.cloudflare.acme.dnschallenge=true"
  - "--certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare"
  - "--certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53"

  # Uncomment for Let's Encrypt staging (testing)
  # - "--certificatesresolvers.cloudflare.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"

# Environment variables (Cloudflare API token)
env:
  - name: CF_API_EMAIL
    value: williamdzink@gmail.com
  - name: CF_DNS_API_TOKEN
    valueFrom:
      secretKeyRef:
        name: cloudflare-api-token
        key: token

# Deployment configuration
deployment:
  enabled: true
  kind: Deployment
  replicas: 1 # Single replica required for ACME with local-path storage

  initContainers:
    - name: acme-permissions
      image: busybox:latest
      command:
        - sh
        - -c
        - |
          touch /data/acme.json
          chmod 600 /data/acme.json
          echo "Set acme.json permissions to 600"

  # Pod anti-affinity - spread across nodes
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8082"

# Ports configuration
ports:
  # Web (HTTP)
  web:
    port: 8000
    exposedPort: 80
    protocol: TCP
    expose:
      default: true

  # WebSecure (HTTPS)
  websecure:
    port: 8443
    exposedPort: 443
    protocol: TCP
    expose:
      default: true
    tls:
      enabled: true

  # Metrics
  metrics:
    port: 8082
    protocol: TCP
    expose:
      default: false

# Service configuration
service:
  enabled: true
  type: LoadBalancer

  # Annotations for MetalLB and External-DNS
  annotations:
    metallb.universe.tf/address-pool: homelab-prod-pool
    # External-DNS will create traefik.zinkzone.tech â†’ LoadBalancer IP
    external-dns.alpha.kubernetes.io/hostname: traefik.zinkzone.tech

# IngressRoute for Traefik dashboard
ingressRoute:
  dashboard:
    enabled: true
    # Access via: https://traefik.zinkzone.tech/dashboard/

# Persistence for ACME certificates
persistence:
  enabled: true
  name: traefik-certs
  accessMode: ReadWriteOnce
  size: 128Mi
  storageClass: "local-path" # K3S default storage class
  path: /data

# Resources
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "500m"
    memory: "512Mi"

# Security context
securityContext:
  capabilities:
    drop: [ALL]
  readOnlyRootFilesystem: true
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532

# Pod security context
podSecurityContext:
  fsGroup: 65532

# Logs
logs:
  general:
    level: INFO
  access:
    enabled: true
